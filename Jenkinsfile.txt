pipeline {
    agent any

    stages {
        stage('GitHub Webhook Trigger') {
            steps {
                script {
                    // Check if the webhookPayload variable is available
                    if (env.webhookPayload) {
                        echo "GitHub Webhook Payload: ${env.webhookPayload}"
                        
                        // Parse the JSON payload
                        def payload = readJSON text: env.webhookPayload
                        
                        // Access specific information from the payload
                        def repositoryName = payload.repository.name
                        def branchName = payload.ref.split('/').last()

                        echo "Repository Name: ${repositoryName}"
                        echo "Branch Name: ${branchName}"

                        // Your custom logic based on GitHub webhook data
                        // For example, trigger specific actions based on branch or event type
                    } else {
                        echo "No GitHub webhook payload found. This build might not be triggered by a webhook."
                    }
                }
            }
        }

        stage("Upload to AWS") {
            steps {
                script {
                    // Use 'findFiles' to locate all .py files
                    def filesToUpload = findFiles(glob: '**/*.py')

                    // Check if the files list is not empty
                    if (!filesToUpload.isEmpty()) {
                        // Print debugging information
                        echo "Files to upload:"
                        filesToUpload.each { file ->
                            echo "- ${file}"

                            // Use withAWS and s3Upload for each file
                            withAWS(credentials: 'AWS_CREDENTIAL_ID', region: 'us-east-1') {
                                echo "Uploading: ${file}"

                                s3Upload(
                                    bucket: 'cicdglue',
                                    includePathPattern: file,
                                    workingDir: ''
                                )
                            }
                        }
                    } else {
                        error "No .py files found in the workspace."
                    }
                }
            }
        }
    }
}
